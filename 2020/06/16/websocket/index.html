<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="WebSocket 入门"><meta name="keywords" content="计算机网络"><meta name="author" content="Yin-Hongwei"><meta name="copyright" content="Yin-Hongwei"><title>WebSocket 入门 | YinHongwei</title><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script></head><body><header id="page-header"><nav id="navbar"><span class="nav-left"><a id="site-name" href="/">YinHongwei</a></span><i class="fa fa-bars toggle-menu nav-right" aria-hidden="true"></i><span class="title">WebSocket 入门</span><span class="nav-right menus"><a class="site-page" href="/about">About Me</a></span></nav></header><article id="content-outer"><section id="content-inner"><article class="article-entry" id="post"><h2 id="一、WebSocket-协议出现背景"><a href="#一、WebSocket-协议出现背景" class="headerlink" title="一、WebSocket 协议出现背景"></a>一、WebSocket 协议出现背景</h2><p>HTTP 协议的建立主要是传输 HTML 文档。但随着时代的发展，HTTP 协议的性能遇到了他的的瓶颈。即通信只能是客户端发起请求，这使得服务器有数据发生了变化客户端只有主动发起请求才能获得最新数据。</p>
<p>之后 comet 的出现实现了内容上的实时更新，但是 HTTP 本身的问题并未解决（通信只能客户端发起），于是出现了 WebSocket 协议。</p>
<blockquote>
<p>comet 是一种服务器向页面推送数据的技术，实现方式有长轮询和 HTTP 流。</p>
</blockquote>
<h2 id="二、WebSocket-协议"><a href="#二、WebSocket-协议" class="headerlink" title="二、WebSocket 协议"></a>二、WebSocket 协议</h2><h3 id="1、概念"><a href="#1、概念" class="headerlink" title="1、概念"></a>1、概念</h3><p>WebSocket 协议是 WEB 浏览器和 WEB 服务器全双工通信的标准。诞生于 2008 年，2011 年成为国际标准，目前支持的浏览器有 Firefox 6+、Safari 5+、Chrome、iOS 4+版Safari。</p>
<p>WebSocket 协议建立在 HTTP 协议基础之上，所以连接的发起方仍是客户端，一旦确立 WebSocket 通信连接，不论服务器还是客户端，任意一方都可直接向对方发送报文。协议的标识符是ws，加密的是wss。</p>
<h3 id="2、特点"><a href="#2、特点" class="headerlink" title="2、特点"></a>2、特点</h3><ul>
<li>服务器向客户直接端推送数据。</li>
<li>首部信息量小，通信量减少。</li>
<li>没有同源的限制。</li>
</ul>
<h3 id="3、通信过程"><a href="#3、通信过程" class="headerlink" title="3、通信过程"></a>3、通信过程</h3><p>WebSocket 通信需要在 HTTP 连接建立之后完成一次握手步骤。</p>
<p>客户端向服务器发送一个请求。需要用到 HTTP 的 Upgrade、Connection 首部字段，告知服务器通信协议发生改变。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /chat HTTP/1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==</span><br><span class="line">Origin: http://example.com</span><br><span class="line">Sec-WebSocket-Protocol: chat, superchat</span><br><span class="line">Sec-WebSocket-Version: 13</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sec-WebSocket-Key 字段内记录着握手过程中必不可少的键值。</span></span><br><span class="line"><span class="comment"># Sec-WebSocket-Protocol 字段内记录使用的子协议。子协议按 WebSocket 协议标准在连接分开使用时，定义那些连接的名称。</span></span><br></pre></td></tr></table></figure>
<p>服务器收到请求后向客户端返回一个状态码 101 的响应。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 101 Switching Protocols</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span><br><span class="line">Sec-WebSocket-Protocol: chat</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sec-WebSocket-Accept 的字段值是由握手请求中的 Sec-WebSocket-Key 的字段值生成的。</span></span><br></pre></td></tr></table></figure>
<p>成功握手确立 WebSocket 连接之后，通信时不再使用 HTTP 的数据帧，而采用 WebSocket 独立的数据帧。</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfylnc3b91j30wg0le11f.jpg" alt=""></p>
<h3 id="4、WebSocket-API"><a href="#4、WebSocket-API" class="headerlink" title="4、WebSocket API"></a>4、WebSocket API</h3><blockquote>
<p>更多详情 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket</a></p>
</blockquote>
<h4 id="1）构造函数"><a href="#1）构造函数" class="headerlink" title="1）构造函数"></a>1）构造函数</h4><p>WebSocket(url[, protocols])，返回一个 <code>WebSocket</code> 对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(url); <span class="comment">// url 是绝对 url</span></span><br></pre></td></tr></table></figure>
<p>实例化 WebSocket 对象后，浏览器就会马上尝试创建连接。</p>
<h4 id="2）属性"><a href="#2）属性" class="headerlink" title="2）属性"></a>2）属性</h4><ul>
<li>readyState</li>
</ul>
<p>与 XHR 类似，WebSocket 也有一个表示当前状态的 readyState 属性，但是的值与 XHR 并不相同。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONNECTING：值为0，表示正在连接。</span><br><span class="line">OPEN：值为1，表示连接成功，可以通信了。</span><br><span class="line">CLOSING：值为2，表示连接正在关闭。</span><br><span class="line">CLOSED：值为3，表示连接已经关闭，或者打开连接失败。</span><br></pre></td></tr></table></figure>
<h4 id="3）方法"><a href="#3）方法" class="headerlink" title="3）方法"></a>3）方法</h4><ul>
<li>send：对要传输的数据进行排队。（复杂的数据，在发送之前要进行序列化）</li>
<li>close：关闭当前链接。</li>
</ul>
<h4 id="4）事件"><a href="#4）事件" class="headerlink" title="4）事件"></a>4）事件</h4><p>使用 <code>addEventListener()</code> 或将一个事件监听器赋值给本接口的 <code>oneventname</code> 属性监听下面的事件。</p>
<ul>
<li>open：当一个 WebSocket 连接成功时触发。</li>
<li>close：当一个 WebSocket 连接被关闭时触发。</li>
<li>message：当通过 WebSocket 收到数据时触发。</li>
<li>error：当一个 WebSocket 连接因错误而关闭时触发，例如无法发送数据时。</li>
</ul>
<h2 id="三、实战"><a href="#三、实战" class="headerlink" title="三、实战"></a>三、实战</h2><h3 id="1、客户端"><a href="#1、客户端" class="headerlink" title="1、客户端"></a>1、客户端</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">"ws://localhost:8888"</span>);</span></span><br><span class="line"><span class="undefined">  </span></span><br><span class="line"><span class="javascript">  ws.onopen = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">'server open'</span>);</span></span><br><span class="line"><span class="javascript">    ws.send(<span class="string">'hello world, server!'</span>);</span></span><br><span class="line"><span class="undefined">  &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">  ws.onmessage = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">"client receive data："</span>, e.data);</span></span><br><span class="line"><span class="undefined">  &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">  ws.onclose = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">"server close"</span>);</span></span><br><span class="line"><span class="undefined">  &#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="2、服务器"><a href="#2、服务器" class="headerlink" title="2、服务器"></a>2、服务器</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> WebSocket = <span class="built_in">require</span>(<span class="string">'ws'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> WebSocket.Server(&#123; <span class="attr">port</span>: <span class="number">8888</span> &#125;);</span><br><span class="line"></span><br><span class="line">ws.on(<span class="string">'connection'</span>, ws =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'websocket connection'</span>);</span><br><span class="line">  </span><br><span class="line">  ws.send(<span class="string">'hello world, client!'</span>);</span><br><span class="line">  </span><br><span class="line">  ws.on(<span class="string">'open'</span>, msg =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server open'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  ws.on(<span class="string">'message'</span>, msg =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server receive msg：'</span>, msg);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  ws.on(<span class="string">'close'</span>, msg =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'client close'</span>,);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Koa is listening in <span class="subst">$&#123;<span class="number">3000</span>&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<div class="qr-code"></div><img class="qrcode-img" src="/img/weixin.jpg"><div class="qrcode-desc">微信打赏</div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/07/22/前端数据存储方案/"><i class="fa fa-chevron-left"></i><span>前端数据存储方案</span></a></div><div class="next-post pull-right"><a href="/2020/03/18/前端模块化/"><span>前端模块化</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: 'e238e2d1f25ec6e15026',
  clientSecret: '3c4e537d46a59d056e6c0cc478b04784defafcfb',
  repo: 'Yin-Hongwei.github.io',
  owner: 'Yin-Hongwei',
  admin: 'Yin-Hongwei',
  id: md5(window.location.pathname)
})
gitalk.render('gitalk-container')</script></article></section></article><footer id="footer-outer"><div id="footer-inner"><p class="footer-text">Copyright &copy; 2018 Yin-Hongwei</p></div></footer></body><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/main.js" defer></script></html>