<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="vue 双向数据绑定"><meta name="keywords" content="vue"><meta name="author" content="Yin-Hongwei"><meta name="copyright" content="Yin-Hongwei"><title>vue 双向数据绑定 | Hongwei Blog</title><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script></head><body><header id="header"><nav id="navbar"><span class="nav-left"><a id="site-name" href="/">Hongwei Blog</a></span><i class="fa fa-bars toggle-menu nav-right" aria-hidden="true"></i><span class="nav-right menus"><a class="site-page" href="/about">关于</a><a class="site-page" href="/archives">存档</a><a class="site-page" href="/tags">标签</a></span></nav></header><article id="content-outer"><section id="content-inner"><article class="article-entry" id="post"><h1>vue 双向数据绑定</h1><p>vue中可以将数据通过v-model指令绑定到一个表单标签上，当操作表单标签时对应的数据也会一起改变。那么实现这种绑定底层是怎么处理的呢？</p>
<a id="more"></a>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">"app"</span>&gt;</span><br><span class="line">  &lt;input v-model=<span class="string">"text"</span>&gt; <span class="string">`&#123;%raw%&#125;  &#123;&#123;text&#125;&#125; &#123;%endraw%&#125;`</span></span><br><span class="line">&lt;<span class="regexp">/div&gt;</span></span><br></pre></td></tr></table></figure>
<p>首先实现双向数据绑定的方法大致如下几种：</p>
<blockquote>
<p> <strong>发布者-订阅者模式（backbone.js）</strong> </p>
</blockquote>
<p>一般通过sub, pub的方式实现数据和视图的绑定监听，更新数据方式通常做法是 <code>vm.set(&#39;property&#39;, value)</code></p>
<p>这种方式现在毕竟太low了，我们更希望通过 <code>vm.property = value</code>这种方式更新数据，同时自动更新视图，于是有了下面两种方式。</p>
<blockquote>
<p> <strong>脏值检查（angular.js） </strong> </p>
</blockquote>
<p>angular.js 是通过脏值检测的方式比对数据是否有变更，来决定是否更新视图，最简单的方式就是通过 <code>setInterval()</code> 定时轮询检测数据变动，当然只有在指定的事件触发时进入脏值检测，大致如下：</p>
<ul>
<li>DOM事件，譬如用户输入文本，点击按钮等。( ng-click )</li>
<li>XHR响应事件 ( $http )</li>
<li>浏览器Location变更事件 ( $location )</li>
<li>Timer事件( \$timeout , $interval )</li>
<li>执行 \$digest() 或 $apply()</li>
</ul>
<blockquote>
<p> <strong>数据劫持（vue.js）</strong></p>
</blockquote>
<p>vue.js 则是采用数据劫持结合发布者-订阅者模式的方式，通过<code>Object.defineProperty()</code>来劫持各个属性的<code>setter</code>，<code>getter</code>，在数据变动时发布消息给订阅者，触发相应的监听回调。</p>
<h2 id="过程描述"><a href="#过程描述" class="headerlink" title="过程描述"></a>过程描述</h2><p>实现数据的双向绑定，首先要对数据进行劫持监听，所以我们需要设置一个监听器 <strong>Observer</strong>用来监听所有的属性。当你把一个普通的 JavaScript 对象传入 Vue 实例作为 data 选项，Vue 将遍历此对象所有的属性，并通过Object.defineProperty() 来劫持各个属性，包括子属性对象的属性，都加上<strong>setter/getter</strong>，当对象的某个值赋值就会触发 setter 去修改属性值。并通过 getter 通知订阅者 <strong>Watcher</strong> 最新的值，因为每个组件实例都对应一个 <strong>watcher</strong> 实例，所以我们需要有一个消息订阅器 Dep 来专门收集这些订阅者，当数据变化的时候消息订阅器 Dep就可以触发相应事件通知订阅者。我们还需要有一个指令解析器 <strong>Compile</strong>，对每个元素节点的指令进行扫描和解析，将模板中的变量替换成数据，然后初始化渲染页面视图，并对每个指令对应的节点绑定更新函数，添加监听数据的订阅，一旦数据有变动，收到通知，更新视图。</p>
<p><img src="/img/data.jpg" width="600"></p>
<h2 id="核心组成"><a href="#核心组成" class="headerlink" title="核心组成"></a>核心组成</h2><h3 id="1-实现Observer"><a href="#1-实现Observer" class="headerlink" title="1.实现Observer"></a>1.实现Observer</h3><p>Observer 的主要功能就是对数据进行劫持监听，要实现 Observer 核心就是利用 Obeject.defineProperty() 来监听属性变动，所以对 observe 的数据对象进行递归遍历，包括子属性对象的属性，都加上 setter 和 getter， 这样当给这个对象的某个属性赋值就会触发 setter，那么就能监听到数据的变化了。代码如下（未考虑对象嵌套的情况）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">Object</span>.keys(data).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">	    defineReactive(data, key, data[key]);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">data, key, val</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(data, key, &#123;</span><br><span class="line">        enumerable: <span class="literal">true</span>, <span class="comment">// 可枚举</span></span><br><span class="line">        configurable: <span class="literal">false</span>, <span class="comment">// 不能再define</span></span><br><span class="line">        get: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> val;</span><br><span class="line">        &#125;,</span><br><span class="line">        set: <span class="function"><span class="keyword">function</span>(<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">            val = newVal;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-实现Compile"><a href="#2-实现Compile" class="headerlink" title="2.实现Compile"></a>2.实现Compile</h3><p>compile 的主要功能是解析模板指令，将模板中的变量替换成数据，初始化渲染页面视图，这时将触发 data 属性的getter，并为每个指令对应的节点添加监听数据的订阅者，绑定更新函数，一旦数据有变动 Watcher 就通知 compile 更新视图。</p>
<p>因为遍历解析的过程要多次操作dom节点，为提高性能和效率，会先将vue实例根节点的<code>el</code>转换成文档碎片<code>fragment</code>进行解析编译操作，解析完成，再将<code>fragment</code>添加回原来的真实dom节点中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 遍历节点，编译节点的每个子节点</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nodeToFragment</span>(<span class="params">node, vm</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fragment = <span class="built_in">document</span>.createDocumentFragment(), child</span><br><span class="line">    <span class="keyword">while</span> (node.firstChild) &#123;</span><br><span class="line">        child = node.firstChild</span><br><span class="line">        compile(child, vm)</span><br><span class="line">        fragment.appendChild(child)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fragment</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>compile 方法将对所有节点进行扫描解析编译，调用对应的指令渲染函数进行数据渲染，并调用对应的指令更新函数进行绑定</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译dom</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compile</span>(<span class="params">node, vm</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> reg = <span class="regexp">/\&#123;\&#123;(.*)\&#125;\&#125;/</span></span><br><span class="line">    <span class="keyword">var</span> nodeType = node.nodeType</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 元素节点</span></span><br><span class="line">    <span class="keyword">if</span> (nodeType === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> attrs = node.attributes</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> attr <span class="keyword">of</span> attrs) &#123;</span><br><span class="line">            <span class="keyword">if</span> (attr.nodeName === <span class="string">'v-model'</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> property = attr.nodeValue</span><br><span class="line">                node.addEventListener(<span class="string">'input'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">ev</span>) </span>&#123;</span><br><span class="line">                    vm[property] = ev.target.value</span><br><span class="line">                &#125;)</span><br><span class="line">                node.value = vm[property]</span><br><span class="line">                <span class="keyword">new</span> Watcher(vm, node, property, <span class="string">'input'</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nodeType === <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (reg.test(node.nodeValue)) &#123;</span><br><span class="line">            <span class="keyword">const</span> property = <span class="built_in">RegExp</span>.$<span class="number">1</span></span><br><span class="line">            node.textContent = vm[property]</span><br><span class="line">            <span class="keyword">new</span> Watcher(vm, node, property, <span class="string">'text'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-实现Watcher"><a href="#3-实现Watcher" class="headerlink" title="3.实现Watcher"></a>3.实现Watcher</h3><p>订阅者Watcher 作为 Observer 和 Compile 之间通信的桥梁，主要的功能是：</p>
<ul>
<li>在Compile 初始化页面的时候创建将自己添加到消息订阅器 Dep 中。</li>
<li>当属性变动时监听器 Observer 触发消息订阅器 dep 的 notify 方法，调用订阅者 Watcher 的 update 方法，并触发Compile 中绑定的回调</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Watcher</span> (<span class="params">vm, node, property, watchType</span>) </span>&#123;</span><br><span class="line">    Dep.target = <span class="keyword">this</span></span><br><span class="line">    <span class="keyword">this</span>.vm = vm</span><br><span class="line">    <span class="keyword">this</span>.watchType = watchType</span><br><span class="line">    <span class="keyword">this</span>.node = node</span><br><span class="line">    <span class="keyword">this</span>.property = property</span><br><span class="line">    <span class="keyword">this</span>.update()</span><br><span class="line">    Dep.target = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line">Watcher.prototype = &#123;</span><br><span class="line">    update: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.get() <span class="comment">// 取到最新值</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.watchType === <span class="string">'input'</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.node.value = <span class="keyword">this</span>.value</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.watchType === <span class="string">'text'</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.node.textContent = <span class="keyword">this</span>.value</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    get: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = <span class="keyword">this</span>.vm[<span class="keyword">this</span>.property]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Dep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.subs = []</span><br><span class="line">&#125;</span><br><span class="line">Dep.prototype = &#123;</span><br><span class="line">    addSubs(sub) &#123;</span><br><span class="line">        <span class="keyword">this</span>.subs.push(sub)</span><br><span class="line">    &#125;,</span><br><span class="line">    notify() &#123;</span><br><span class="line">        <span class="keyword">this</span>.subs.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">sub</span>) </span>&#123;</span><br><span class="line">            sub.update() <span class="comment">// 调用订阅者的update方法，通知变化</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="4-实现MVVM"><a href="#4-实现MVVM" class="headerlink" title="4.实现MVVM"></a>4.实现MVVM</h3><p>MVVM 作为数据绑定的入口，整合 Observer、Compile 和 Watcher 三者，通过Observer来监听自己的model数据变化，通过 Compile 来解析编译模板指令，最终利用 Watcher 搭起 Observer 和 Compile 之间的通信桥梁，达到数据变化 -&gt; 视图更新；视图交互变化(input) -&gt; 数据model变更的双向绑定效果。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">opts</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.el = opts.el</span><br><span class="line">    <span class="keyword">this</span>.data = opts.data || &#123;&#125;</span><br><span class="line">    <span class="keyword">this</span>.init()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">Vue.prototype = &#123;</span><br><span class="line">    init() &#123;</span><br><span class="line">        observe(<span class="keyword">this</span>.data, <span class="keyword">this</span>)</span><br><span class="line">        <span class="keyword">var</span> dom = nodeToFragment(<span class="built_in">document</span>.getElementById(<span class="keyword">this</span>.el), <span class="keyword">this</span>)</span><br><span class="line">        <span class="built_in">document</span>.getElementById(<span class="keyword">this</span>.el).appendChild(dom)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">'app'</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        text: <span class="string">'hello world'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><h4 id="Object-defineProperty-obj-prop-descriptor"><a href="#Object-defineProperty-obj-prop-descriptor" class="headerlink" title="Object.defineProperty(obj, prop, descriptor)"></a>Object.defineProperty(obj, prop, descriptor)</h4><p>Object.defineProperty() 方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性，并返回这个对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// obj 要在其上定义属性的对象。</span></span><br><span class="line"><span class="comment">// prop 要定义或修改的属性的名称。</span></span><br><span class="line"><span class="comment">// descriptor 将被定义或修改的属性描述符。</span></span><br><span class="line"><span class="comment">// 返回值 被传递给函数的对象。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = <span class="built_in">Object</span>.defineProperty(&#123;&#125;, <span class="string">'name'</span>, &#123;</span><br><span class="line">	value: <span class="number">1</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(obj) <span class="comment">// &#123;name: 1&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="getter-setter"><a href="#getter-setter" class="headerlink" title="getter/setter"></a>getter/setter</h4><p>getter/setter 对用户来说是不可见的，但是在内部它们让 Vue 追踪依赖，在属性被访问和修改时通知变化。</p>
<h4 id="createDocumentFragment"><a href="#createDocumentFragment" class="headerlink" title="createDocumentFragment()"></a>createDocumentFragment()</h4><p>DocumentFragment节点不属于文档树，继承的parentNode属性总是null。它有一个很实用的特点，当请求把一个DocumentFragment节点插入文档树时，插入的不是DocumentFragment自身，而是它的所有子孙节点。</p>
<p>参考链接</p>
<p><a href="https://github.com/DMQ/mvvm" target="_blank" rel="noopener">https://github.com/DMQ/mvvm</a></p>
<p><a href="http://lavyun.cn/blog/20171021-mvvm" target="_blank" rel="noopener">http://lavyun.cn/blog/20171021-mvvm</a></p>
<div class="qr-code"></div><img class="qrcode-img" src="/img/weixin.jpg"><div class="qrcode-desc">微信打赏</div><div class="post-tag-list">标签: <a class="post-tags" href="/tags/vue/">vue</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/08/17/JS事件循环/"><i class="fa fa-chevron-left"></i><span>JavaScript 之 Event Loop</span></a></div><div class="next-post pull-right"><a href="/2018/07/29/网易云音乐/"><span>vue-网易云音乐</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: 'e238e2d1f25ec6e15026',
  clientSecret: '3c4e537d46a59d056e6c0cc478b04784defafcfb',
  repo: 'Yin-Hongwei.github.io',
  owner: 'Yin-Hongwei',
  admin: 'Yin-Hongwei',
  id: md5(window.location.pathname)
})
gitalk.render('gitalk-container')</script></article></section></article><footer id="footer-outer"><div id="footer-inner"><p class="footer-text">Copyright &copy; 2018-2019</p><p class="footer-text">Designed by Yin-Hongwei</p></div></footer></body><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://hecdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/main.js" defer></script></html>