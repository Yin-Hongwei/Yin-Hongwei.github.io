<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="JavaScript 中的动画问题"><meta name="keywords" content="JavaScript"><meta name="author" content="Yin-Hongwei"><meta name="copyright" content="Yin-Hongwei"><title>JavaScript 中的动画问题 | Yin-Hongwei</title><link rel="icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script></head><body><header id="page-header"><nav id="navbar"><span class="nav-left"><div class="tou-img"><img src="/img/avatar.jpg"></div><a id="site-name" href="/">Yin-Hongwei</a></span><i class="fa fa-bars toggle-menu nav-right" aria-hidden="true"></i><span class="title">JavaScript 中的动画问题</span><span class="nav-right menus"><a class="site-page" href="/about">关于我</a></span></nav></header><article id="content-outer"><section id="content-inner"><article id="post"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="sidebar-toc"><div class="sidebar-toc__title">大纲</div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、setTimeout、setInterval"><span class="toc-text">一、setTimeout、setInterval</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、RequestAnimationFrame"><span class="toc-text">二、RequestAnimationFrame</span></a></li></ol></div></div></div><div class="article-container" id="post-content"><p>实现动画效果方式有很多，可以是 CSS3 的 transition 和 animation，可以是 JavaScript 的 setTimeout、setInterval， 也可以是 html5 的 RequestAnimationFrame。本文主要针对后两种方式做一下介绍。</p>
<a id="more"></a>
<h2 id="一、setTimeout、setInterval"><a href="#一、setTimeout、setInterval" class="headerlink" title="一、setTimeout、setInterval"></a>一、setTimeout、setInterval</h2><p>在 JavaScript 中创建动画的典型方式，就是使用 setInterval() 方法来控制所有动画。如下: </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">updateAnimations</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    doAnimation1(); </span><br><span class="line">    doAnimation2(); <span class="comment">//其他动画</span></span><br><span class="line">&#125;</span><br><span class="line">  setInterval(updateAnimations, <span class="number">100</span>);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>实现的想法是以一定的延迟时间不停的运行 updateAnimations() 方法，让它去运行每个动画并更改不同元素的状态。</p>
<blockquote>
<p>最佳循环间隔：大多数电脑显示器的刷新频率是 60Hz，大概相当于每秒钟重绘 60 次。最平滑动画的最佳循环间隔是 1000ms/60，约等于 17ms</p>
</blockquote>
<p>但实际的结果是传入的延迟时间只是指定了什么时候把动画代码添加到任务队列中以等待执行。如果队列前面已经加入了其他任务，那动画代码就要等前面的任务完成后再执行。因此setInterval()、setTimeout()都不是很精确。</p>
<p>引起问题的原因是我们想的是传入一个时间让这个函数多久再去运行，但实际浏览器是过了这么久才把它加到任务队列中，要想精确绘制动画，是要确定下一步开始绘制动画的时间，而不是加到队列中的时间，<strong>mozRequestAnimationFrame</strong> 就很好的解决了这个问题。</p>
<h2 id="二、RequestAnimationFrame"><a href="#二、RequestAnimationFrame" class="headerlink" title="二、RequestAnimationFrame"></a>二、RequestAnimationFrame</h2><p>与 setTimeout 和 setInterval 不同，requestAnimationFrame 只需要一个回调函数作为参数，不需要设置时间间隔， 它会告诉浏览器希望执行动画并请求浏览器在下一次重绘之前调用指定的函数来更新动画。</p>
<p>大多数电脑显示器的刷新频率是 60Hz，大概相当于每秒钟重绘 60 次。大多数浏览器都会对重绘操作加以限制，不超过显示器的重绘频率，因为即使超过那个频率用户体验也不会有提升。因此，最平滑动画的最佳循环间隔是 1000ms/60，约等于 16.6ms。</p>
<p>使用 RequestAnimationFrame 实现动画的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateProgress</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> div = <span class="built_in">document</span>.getElementById(<span class="string">"status"</span>);</span><br><span class="line">  div.style.width = (<span class="built_in">parseInt</span>(div.style.width, <span class="number">10</span>) + <span class="number">5</span>) + <span class="string">"%"</span>;</span><br><span class="line">  <span class="keyword">if</span> (div.style.left != <span class="string">"100%"</span>)&#123;</span><br><span class="line">    RequestAnimationFrame(updateProgress);</span><br><span class="line">&#125; &#125;</span><br><span class="line">RequestAnimationFrame(updateProgress);</span><br><span class="line"><span class="comment">// 其实现的想法是 RequestAnimationFrame() 只运行一次传入的函数，在需要再次生成动画时需要再次手动调用它。同时也要考虑什么时候停止动画。这样就能得到非常平滑流畅的动画。</span></span><br></pre></td></tr></table></figure>
<p>特点:</p>
<ul>
<li><p>requestAnimationFrame 会把每一帧中的所有 DOM 操作集中起来，在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率。 </p>
</li>
<li><p>在隐藏或不可见的元素中，requestAnimationFrame 将不会进行重绘或回流，这当然就意味着更少的 CPU、GPU 和内存使用量。</p>
</li>
<li><p>requestAnimationFrame 是由浏览器专门为动画提供的 API，在运行时浏览器会自动优化方法的调用，并且如果页面不是激活状态下的话，动画会自动暂停，有效节省了 CPU 开销。</p>
</li>
</ul>
<p>下面就看个例子吧。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        #progress &#123;</span><br><span class="line">            background-color: #95d1f7;</span><br><span class="line">            width: 0;</span><br><span class="line">            height: 40px;</span><br><span class="line">            line-height: 40px;</span><br><span class="line">            border-radius: 20px;</span><br><span class="line">            text-indent: 20px;</span><br><span class="line">        &#125;</span><br><span class="line">        #btn &#123;</span><br><span class="line">            width: 50px;</span><br><span class="line">            height: 30px;</span><br><span class="line">            margin: 10px;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"progress"</span>&gt;</span>0%<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btn"</span>&gt;</span>btn<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> timer = <span class="literal">null</span>;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> btn = <span class="built_in">document</span>.getElementById(<span class="string">'btn'</span>);</span></span><br><span class="line"><span class="javascript">    btn.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> progress = <span class="built_in">document</span>.getElementById(<span class="string">'progress'</span>);</span></span><br><span class="line"><span class="javascript">        progress.style.width = <span class="string">'0'</span>;</span></span><br><span class="line">        cancelAnimationFrame(timer);</span><br><span class="line"><span class="javascript">        timer = requestAnimationFrame(<span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span>(<span class="built_in">parseInt</span>(progress.style.width) &lt; <span class="number">500</span>)&#123;</span></span><br><span class="line"><span class="javascript">                progress.style.width = <span class="built_in">parseInt</span>(progress.style.width) + <span class="number">5</span> + <span class="string">'px'</span>;</span></span><br><span class="line"><span class="javascript">                progress.innerHTML = <span class="built_in">parseInt</span>(progress.style.width)/<span class="number">5</span> + <span class="string">'%'</span>;</span></span><br><span class="line">                timer = requestAnimationFrame(fn);</span><br><span class="line"><span class="javascript">            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">                cancelAnimationFrame(timer); <span class="comment">// 取消定时器</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div><div class="qr-code"></div><img class="qrcode-img" src="/img/weixin.jpg"><div class="qrcode-desc">微信打赏</div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/11/04/Git 常用命令/"><i class="fa fa-chevron-left"></i><span>Git 常用命令</span></a></div><div class="next-post pull-right"><a href="/2019/08/01/koa简介/"><span>koa 简介</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: 'e238e2d1f25ec6e15026',
  clientSecret: '3c4e537d46a59d056e6c0cc478b04784defafcfb',
  repo: 'Yin-Hongwei.github.io',
  owner: 'Yin-Hongwei',
  admin: 'Yin-Hongwei',
  id: md5(window.location.pathname)
})
gitalk.render('gitalk-container')</script></article></section></article><footer id="footer-outer"><div id="footer-inner"><p class="footer-text">Copyright &copy; 2018-2022 Yin-Hongwei</p></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i></body><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/utils.js" defer></script><script src="/js/transition.js" defer></script><script src="/js/fancybox.js" defer></script><script src="/js/menu.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/scroll.js" defer></script></html>