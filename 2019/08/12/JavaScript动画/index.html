<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="JavaScript 中的动画问题"><meta name="keywords" content="JavaScript"><meta name="author" content="Yin-Hongwei"><meta name="copyright" content="Yin-Hongwei"><title>JavaScript 中的动画问题 | Hongwei Blog</title><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script></head><body><header id="page-header"><nav id="navbar"><span class="nav-left"><div class="tou-img"><img src="/img/tou.jpg"></div><a id="site-name" href="/">Hongwei Blog</a></span><i class="fa fa-bars toggle-menu nav-right" aria-hidden="true"></i><span class="nav-right menus"><a class="site-page" href="/about">关于</a><a class="site-page" href="/archives">存档</a><a class="site-page" href="/tags">标签</a></span></nav></header><article id="content-outer"><section id="content-inner"><article class="article-entry" id="post"><h1>JavaScript 中的动画问题</h1><p>实现动画效果方式有很多，可以是 CSS3 的 transition 和 animation，可以是 JavaScript 的 setTimeout、setInterval， 也可以是 html5 的 RequestAnimationFrame。本文主要针对后两种方式做一下介绍。</p>
<a id="more"></a>
<h2 id="一、setTimeout、setInterval"><a href="#一、setTimeout、setInterval" class="headerlink" title="一、setTimeout、setInterval"></a>一、setTimeout、setInterval</h2><p>在 JavaScript 中创建动画的典型方式，就是使用 setInterval() 方法来控制所有动画。如下: </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">updateAnimations</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    doAnimation1(); </span><br><span class="line">    doAnimation2(); <span class="comment">//其他动画</span></span><br><span class="line">&#125;</span><br><span class="line">  setInterval(updateAnimations, <span class="number">100</span>);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>实现的想法是以一定的延迟时间不停的运行 updateAnimations() 方法，让它去运行每个动画并更改不同元素的状态。</p>
<blockquote>
<p>最佳循环间隔：大多数电脑显示器的刷新频率是 60Hz，大概相当于每秒钟重绘 60 次。最平滑动画的最佳循环间隔是 1000ms/60，约等于 17ms</p>
</blockquote>
<p>但实际的结果是传入的延迟时间只是指定了什么时候把动画代码添加到任务队列中以等待执行。如果队列前面已经加入了其他任务，那动画代码就要等前面的任务完成后再执行。因此setInterval()、setTimeout()都不是很精确。</p>
<p>引起问题的原因是我们想的是传入一个时间让这个函数多久再去运行，但实际浏览器是过了这么久才把它加到任务队列中，要想精确绘制动画，是要确定下一步开始绘制动画的时间，而不是加到队列中的时间，<strong>mozRequestAnimationFrame</strong> 就很好的解决了这个问题。</p>
<p><strong>PS：对任务队列不了解可以看这里</strong></p>
<p><a href="https://yin-hongwei.github.io/2018/08/17/JS事件循环/#more">传送门</a></p>
<p><a href="http://www.ruanyifeng.com/blog/2014/10/event-loop.html" target="_blank" rel="noopener">我再传</a></p>
<h2 id="二、RequestAnimationFrame"><a href="#二、RequestAnimationFrame" class="headerlink" title="二、RequestAnimationFrame"></a>二、RequestAnimationFrame</h2><p>使用 RequestAnimationFrame 实现动画的代码如下（可以像 setTimeout()一样使用）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateProgress</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> div = <span class="built_in">document</span>.getElementById(<span class="string">"status"</span>);</span><br><span class="line">  div.style.width = (<span class="built_in">parseInt</span>(div.style.width, <span class="number">10</span>) + <span class="number">5</span>) + <span class="string">"%"</span>;</span><br><span class="line">  <span class="keyword">if</span> (div.style.left != <span class="string">"100%"</span>)&#123;</span><br><span class="line">    RequestAnimationFrame(updateProgress);</span><br><span class="line">&#125; &#125;</span><br><span class="line">RequestAnimationFrame(updateProgress);</span><br></pre></td></tr></table></figure>
<p>其实现的想法是 RequestAnimationFrame() 只运行一次传入的函数，在需要再次生成动画时需要再次手动调用它。同时也要考虑什么时候停止动画。这样就能得到非常平滑流畅的动画。</p>
<p>实际的结果是RequestAnimationFrame()函数会接收一个参数，它是一个时间码(从1970年1月1日起至今的毫秒数)，表示下一次重绘的实际发生时间。RequestAnimationFrame() 会根据这个时间码设定将来的某个时刻进行重绘。这就很好的解决了代码什么时候执行的问题。</p>
<p>下面就看个例子吧。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">        #progress &#123;</span></span><br><span class="line"><span class="undefined">            background-color: #95d1f7;</span></span><br><span class="line"><span class="undefined">            width: 0;</span></span><br><span class="line"><span class="undefined">            height: 40px;</span></span><br><span class="line"><span class="undefined">            line-height: 40px;</span></span><br><span class="line"><span class="undefined">            border-radius: 20px;</span></span><br><span class="line"><span class="undefined">            text-indent: 20px;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">        #btn &#123;</span></span><br><span class="line"><span class="undefined">            width: 50px;</span></span><br><span class="line"><span class="undefined">            height: 30px;</span></span><br><span class="line"><span class="undefined">            margin: 10px;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"progress"</span>&gt;</span>0%<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btn"</span>&gt;</span>btn<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> timer = <span class="literal">null</span>;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> btn = <span class="built_in">document</span>.getElementById(<span class="string">'btn'</span>);</span></span><br><span class="line"><span class="javascript">    btn.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> progress = <span class="built_in">document</span>.getElementById(<span class="string">'progress'</span>);</span></span><br><span class="line"><span class="javascript">        progress.style.width = <span class="string">'0'</span>;</span></span><br><span class="line"><span class="undefined">        cancelAnimationFrame(timer);</span></span><br><span class="line"><span class="javascript">        timer = requestAnimationFrame(<span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span>(<span class="built_in">parseInt</span>(progress.style.width) &lt; <span class="number">500</span>)&#123;</span></span><br><span class="line"><span class="javascript">                progress.style.width = <span class="built_in">parseInt</span>(progress.style.width) + <span class="number">5</span> + <span class="string">'px'</span>;</span></span><br><span class="line"><span class="javascript">                progress.innerHTML = <span class="built_in">parseInt</span>(progress.style.width)/<span class="number">5</span> + <span class="string">'%'</span>;</span></span><br><span class="line"><span class="undefined">                timer = requestAnimationFrame(fn);</span></span><br><span class="line"><span class="javascript">            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">                cancelAnimationFrame(timer); <span class="comment">// 取消定时器</span></span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="qr-code"></div><img class="qrcode-img" src="/img/weixin.jpg"><div class="qrcode-desc">微信打赏</div><div class="post-tag-list">标签: <a class="post-tags" href="/tags/JavaScript/">JavaScript</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/11/04/Git命令/"><i class="fa fa-chevron-left"></i><span>Git 常用命令</span></a></div><div class="next-post pull-right"><a href="/2019/07/29/hexo/"><span>Hexo 主题制作</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: 'e238e2d1f25ec6e15026',
  clientSecret: '3c4e537d46a59d056e6c0cc478b04784defafcfb',
  repo: 'Yin-Hongwei.github.io',
  owner: 'Yin-Hongwei',
  admin: 'Yin-Hongwei',
  id: md5(window.location.pathname)
})
gitalk.render('gitalk-container')</script></article></section></article><footer id="footer-outer"><div id="footer-inner"><p class="footer-text">Copyright &copy; 2018-2021</p><p class="footer-text">Designed by Yin-Hongwei</p></div></footer></body><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/main.js" defer></script><script src="/js/scroll.js" defer></script></html>